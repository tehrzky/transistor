name: Build Transistor with Google Drive Sync

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout original Transistor
      run: |
        git clone https://codeberg.org/y20k/transistor.git .
        
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Add Google Drive sync permissions
      run: |
        # Add Google Drive permission to AndroidManifest.xml
        sed -i '/<uses-permission android:name="android.permission.WAKE_LOCK" \/>/a\    <uses-permission android:name="android.permission.GET_ACCOUNTS" \/>' app/src/main/AndroidManifest.xml
        
        # Add sync settings activity to manifest
        sed -i '/<\/application>/i\        <activity\n            android:name="org.y20k.transistor.ui.SyncSettingsActivity"\n            android:label="Google Drive Sync"\n            android:exported="false" \/>' app/src/main/AndroidManifest.xml
        
    - name: Add Google Drive dependencies
      run: |
        # Add Google Drive dependencies to build.gradle
        sed -i '/implementation.*androidx.work:work-runtime-ktx/a\    implementation '\''com.google.apis:google-api-services-drive:v3-rev20220815-2.0.0'\''\n    implementation '\''com.google.api-client:google-api-client-android:1.23.0'\''\n    implementation '\''com.google.oauth-client:google-oauth-client-jetty:1.23.0'\''\n    implementation '\''com.google.android.gms:play-services-auth:20.7.0'\''\n    implementation '\''com.google.code.gson:gson:2.10.1'\''' app/build.gradle
        
    - name: Create sync directory
      run: |
        mkdir -p app/src/main/java/org/y20k/transistor/sync
        mkdir -p app/src/main/java/org/y20k/transistor/ui
        
    - name: Add Google Drive Sync Service
      run: |
        cat > app/src/main/java/org/y20k/transistor/sync/GoogleDriveSyncService.kt << 'EOF'
